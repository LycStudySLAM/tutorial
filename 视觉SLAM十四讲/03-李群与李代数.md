# 李群与李代数

以下内容为高翔《视觉SLAM十四讲》第二版的学习笔记

## 回顾

上一讲介绍了三维世界中刚体运动的描述方式，包括旋转矩阵，旋转向量，欧拉角，四元数等，但SLAM中不仅需要位姿的表示，还需要位姿的优化，其核心问题是**什么样的相机位姿最有可能观察到这样的观测数据**，解决这类问题往往建模为优化问题，再求解最优的R，t使误差最小化。话虽如此，旋转矩阵自身有正交矩阵和行列式为1的约束，在优化中会带来许多附加的问题，为了解决这个问题，引入李群和李代数的概念。之前已经讨论了这两个特殊的群
$$
SO(n)=\{R\in R^{n\times n}|RR^T=I,det(R)=1\}\\
SE(3)=\{T=\begin{bmatrix}R&t\\0^T&1\end{bmatrix} \in R^{4\times 4}|
R\in SO(3),t\in R^3\}
$$
## 群基础

群是**一种集合**加上**一种运算**的代数结构，记集合A，运算·，集合内元素为a，则群满足
$$
\forall a_1,a_2\in A,a_1·a_2\in A\\
\forall a_1,a_2,a_3\in A,a_1·(a_2·a_3)=(a_1·a_2)·a_3\\
\exists a_0\in A,\forall a\in A,a·a_0=a_0·a=a\\
\forall a\in A, \exists a^{-1}\in A,a·a^{-1}=a_0
$$
上面四个性质分别称为封闭性，结合性，幺元和逆

可以看出，旋转矩阵的集合与矩阵乘法运算构成群，变换矩阵的集合与矩阵乘法也构成群。

## 李群

李群是指具有连续（光滑）性质的群，不同于类似整数群这样离散的群。旋转矩阵群和变换矩阵群表示着n维空间连续运动的结构，显然其不是离散的而是连续光滑的，也属于李群的范畴。

## 李代数的引入

$$
由于旋转矩阵的正交性\quad RR^T=I\\
对于任意时刻的R,有函数R(t),显然地,R(t)R(t)^T=I\\
两边对标量t求导:(R(t))'R(t)^T+(R(t)^T)'R(t)=0\\
移项并由向量微积分性质:(R(t))'R(t)^T=-(R(t)'R(t)^T)^T\\
记A=(R(t))'R(t)^T,则A=-A^T,这是一个反对称矩阵\\
若三维向量a^{\wedge}=A,则记A^{\vee}=a\\
从而可以记(R(t))'R(t)^T=\phi(t)^{\wedge},其中\phi(t)为三维向量\\
两边右乘R(t):R(t)'=\phi(t)^{\wedge}R(t)\\
$$

现在我们可以发现，对R求一次导就是左乘一个对应的三维向量φ的反对称矩阵
$$
考虑t_0=0时，设此时的旋转矩阵R(t_0)=I，按照导数性质在t_0附近进行一阶泰勒展开\\
R(t)\approx R(t_0)+R'(t_0)(t-t_0)=I+\phi(t_0)^{\wedge}R(t_0)(t)=I+\phi(t_0)^{\wedge}(t)\\
$$
这一步可以看出三维向量φ反映了R的导数性质。

此时再联立上述的式子
$$
R(t)'=\phi(t)^{\wedge}R(t)，在t=t_0附近，设\phi保持为常数，即\phi(t_0)^{\wedge}=\phi_0^{\wedge}\\又有初值R(0)=I,解此微分方程得R(t)=\exp(\phi_0^{\wedge}t),t在t_0附近
$$
这一结果说明了在t=0附近，R可以由三维向量φ的反对称矩阵经过指数运算计算出来，但到目前为止，这个exp符号如何计算（毕竟这是矩阵的指数）、三维向量φ有什么性质我们还是不清楚的，因此还要继续深入对李代数的理解。

## 李代数的定义

李代数的定义比较复杂，由一个集合V，一个数域F和一个二元运算符[]（称为李括号）组成。
$$
\forall X,Y \in V,[X,Y]\in V\\
\forall X,Y,Z\in V,a,b\in F,[aX+bY,Z]=a[X,Z]+b[Y,Z],[Z,aX+bY]=a[Z,X]+b[Z,Y]\\
\forall X\in V,[X,X]=0\\
\forall X,Y,Z\in V,[X,[Y,Z]]+[Z,[X,Y]]+[Y,[Z,X]]=0\\
$$
上面的性质分别称为封闭性，双线性，自反性和雅可比等价。为了便于理解，一个简单的李代数例子是三维空间集合V，实数域R和叉积组成了一个李代数，读者可以自行验证上面的四条性质是否符合。下面主要展开李代数so(3)和se(3)的性质。

### so(3)

李代数的引入一节中的φ就是一种李代数,且
$$
\phi=[\phi_1,\phi_2,\phi_3],\Phi=\phi^{\wedge}=\begin{bmatrix}0&-\phi_3&\phi_2\\\phi_3&0&-\phi_1\\-\phi_2&\phi_1&0\end{bmatrix}
$$
其二元运算符为
$$
[\phi_1,\phi_2]=[\Phi_1\Phi_2-\Phi_2\Phi_1]^{\vee}
$$
上面这个反反对称运算符为从三维方阵到三维向量的映射，与反对称运算符对应的映射相反。

so(3)的元素定义为三维向量或者三维反对称矩阵（这两者本身是一一对应的）
$$
so(3)=\{\phi\in R^3,\Phi\in R^{3\times 3}\}
$$

### se(3)

$$
se(3)=\{\xi=\begin{bmatrix}\rho\\\phi\end{bmatrix}\in R^6,\rho\in R^3,\phi\in so(3),
\xi^{\wedge}=\begin{bmatrix}\phi^{\wedge}&\rho\\0^T&0\end{bmatrix}\in R^{4\times 4}
$$

se(3)是由一个平移(与前述的变换矩阵中的平移含义并不一致）和一个so(3)三维向量组成的六维向量，反对称符号表示的转换为一由六维向量到四维方阵的映射，而不是表示向量的反对称矩阵

其二元运算符为
$$
[\xi_1,\xi_2]=[\xi_1^{\wedge}\xi_2^{\wedge}-\xi_2^{\wedge}\xi_1^{\wedge}]^{\vee}
$$
其中，反反对称运算符为从四维方阵到六维向量的一个映射

## 指数映射和对数映射

### SO(3)与so(3)的映射

由李代数的引入一节，如果固定了时刻t，那么有李代数so(3)到李群SO(3)的映射
$$
R=\exp(\phi^{\wedge})
$$
对exp函数进行泰勒展开
$$
\exp(\phi^{\wedge})=\sum_{n=0}^{\infty}\frac{(\phi^{\wedge})^n}{n!}
$$
这看起来需要求一个无穷级数，还要计算李代数反对称矩阵的n次幂，不过根据相似对角化的知识，对称矩阵的对角化一定可以为高次幂带来比较简单的运算，首先，先将李代数表示如下
$$
\phi=\theta a
$$
其中θ是该三维向量的模长，a是单位长度的方向向量,则有
$$
a^{\wedge}a^{\wedge}=aa^T-I\\
a^{\wedge}a^{\wedge}a^{\wedge}=-a^{\wedge}
$$
证明如下
$$
a^{\wedge}a^{\wedge}=
\begin{bmatrix}
-a_2^2-a_3^2&a_1a_2&a_1a_3\\
a_1a_2&-a_1^2-a_3^2&a_2a_3\\
a_1a_3&a_2a_3&-a_1^2-a_2^2
\end{bmatrix}\\
aa^T=\begin{bmatrix}a_1&a_2&a_3\end{bmatrix}
\begin{bmatrix}a_1\\a_2\\a_3\end{bmatrix}=
\begin{bmatrix}
a_1^2&a_1a_2&a_1a_3\\
a_1a_2&a_2^2&a_2a_3\\
a_1a_3&a_2a_3&a_3^2
\end{bmatrix}\\
a_1^2+a_2^2+a_3^2=1\\
\rightarrow a^{\wedge}a^{\wedge}=aa^T-I\\
$$

$$
a^{\wedge}a^{\wedge}a^{\wedge}=a^{\wedge}(aa^T-I)\\
a^{\wedge}a=a\times a=0\\
\rightarrow a^{\wedge}a^{\wedge}a^{\wedge}=a^{\wedge}(-I)=-a^{\wedge}
$$

有了上述的简化基础，此时再进行运算
$$
\exp(\phi^{\wedge})=\sum_{n=0}^{\infty}\frac{(\theta a^{\wedge})^n}{n!}=
I+\theta a^{\wedge}+
\frac{\theta^2 a^{\wedge}a^{\wedge}}{2!}+
\frac{\theta^3 a^{\wedge}a^{\wedge}a^{\wedge}}{3!}+...=\\
aa^T-a^{\wedge}a^{\wedge}+\theta a^{\wedge}+
\frac{\theta^2 a^{\wedge}a^{\wedge}}{2!}+
\frac{\theta^3 a^{\wedge}a^{\wedge}a^{\wedge}}{3!}+...=\\
aa^T+
(\theta-\frac{\theta^3}{3!}+\frac{\theta^5}{5!}+...)a^{\wedge}-
(1-\frac{\theta^2}{2!}+\frac{\theta^4}{4!}+...))a^{\wedge}a^{\wedge}=\\
aa^T+sin\theta a^{\wedge}-cos\theta a^{\wedge}a^{\wedge}=
aa^T+sin\theta a^{\wedge}-cos\theta (aa^T-I)=\\
cos\theta I+(1-cos\theta)aa^T+sin\theta a^{\wedge}
$$
容易发现，这就是上一讲中描述旋转矩阵与旋转向量关系的**罗德里格斯公式**，李代数so(3)对应的正是**旋转向量**组成的空间，在角度θ限定在一个2π角度内时，可以得到李代数so(3)到李群SO(3)的一个唯一指数映射，SO(3)映射到so(3)称为对数映射，计算较为复杂。
$$
\phi=\ln(R)^{\vee}=(\sum_{n=0}^{\infty}\frac{(-1)^n}{(n+1)}(R-I)^{n+1})^{\vee}
$$
通过旋转向量一节的方法，分别算出转角和转轴，相对计算对数映射公式更为简便。
$$
\theta = arccos(\frac{tr(R)-1}{2})\\
Rn=n
$$


### SE(3)与se(3)的映射

$$
\exp(\xi^{\wedge})=
\begin{bmatrix}
\sum_{n=0}^{\infty}\frac{(\phi^{\wedge})^n}{n!}&
\sum_{n=0}^{\infty}\frac{(\phi^{\wedge})^n}{(n+1)!}\rho\\
0^T&1
\end{bmatrix}
=
\begin{bmatrix}
R&J\rho\\
0^T&1
\end{bmatrix}
$$

类似上文so(3)的推导，可以比较快的得到
$$
J=\frac{sin\theta}{\theta}I+(1-\frac{sin\theta}{\theta})aa^T+(\frac{1-cos\theta}{\theta})a^{\wedge}
$$
则两者的相互映射关系可以写作如下
$$
se(3)\rightarrow SE(3):R=\exp(\phi^{\wedge})=cos\theta I+(1-cos\theta)aa^T+sin\theta a^{\wedge}\\
J=\frac{sin\theta}{\theta}I+(1-\frac{sin\theta}{\theta})aa^T+(\frac{1-cos\theta}{\theta})a^{\wedge},t=J\rho\\
SE(3)\rightarrow se(3):\theta = arccos(\frac{tr(R)-1}{2}),Rn=n,t=J\rho\\
$$



上面介绍了李代数的定义，SLAM中最常用的两类李代数so(3)和se(3)，但切莫忘记为什么要使用李代数。目前看来，李代数可以和李群在一个2π角度内形成唯一映射，那么对于李群的乘法（也就是一次旋转），在李代数上是怎么表达与计算呢？

## 李代数求导

根据指数公式在标量上的表示，我们难免有一个美好的想法：
$$
ln(\exp(A)\exp(B))=A+B\\
$$
因为根据标量的指数函数就有这样的性质，然而很遗憾，对于矩阵的指数函数并没有这样的性质。

### BCH公式

上面的式子实际上可由BCH公式定量说明
$$
ln(\exp(A)\exp(B))= A+B+\frac{1}{2}[A,B]^{\wedge}+...
$$

### 近似公式

根据BCH公式，令其中一个李代数为小量，以至于其二阶以上的项都可以被忽略
$$
ln(\exp(\phi_1^{\wedge})\exp(\phi_2^{\wedge}))^{\vee}	\approx
\begin{cases}
J_l(\phi_2)\phi_1^{-1}+\phi_2 \qquad & 当\phi_1为小量，左乘模型 \\
J_r(\phi_1)\phi_2^{-1}+\phi_1 \qquad & 当\phi_2为小量，右乘模型
\end{cases}
$$
其中
$$
J_l=\frac{sin\theta}{\theta}I+(1-\frac{sin\theta}{\theta})aa^T+(\frac{1-cos\theta}{\theta})a^{\wedge}\\
J_l^{-1}=\frac{\theta cot(\theta/2)}{2}I+(1-\frac{\theta cot(\theta/2)}{2})aa^T+(\frac{\theta}{2})a^{\wedge}\\
J_r(\phi)=J_l(-\phi)
$$
以李群左乘一个小量为例，左乘一个微小旋转△R，则李群上为△R·R，对应到李代数上，是一个加法运算
$$
\exp(\Delta\phi^{\wedge})\exp(\phi^{\wedge})=\exp((\phi+J_l(\phi)\Delta\phi)^{\wedge})
$$
如果是在李代数上做一个微小量的加法
$$
\exp((\phi+\Delta\phi)^{\wedge})=
\exp((J_l(\phi)\Delta\phi)^{\wedge})\exp(\phi^{\wedge})=
\exp(\phi^{\wedge})\exp((J_r(\phi)\Delta\phi)^{\wedge})
$$
对于变换矩阵群SE(3)和李代数se(3)也有类似的近似公式，不过形式更为复杂，一般工程中直接调用对应计算库计算，故不赘述。

### 求导

#### 求导原因

设想一个简单的位姿估计问题，对世界坐标系的点集P，在位姿T得到了得到了观测点集Z，由前面的知识，对每一点有
$$
z=Tp+w
$$
其中w为观测数据带来的误差。

为了最小化误差，一般采用最小二乘法做最优估计，即
$$
min_TJ(T)=\sum_{i=1}^{N}||z_i-Tp_i||_2^2
$$
求解此问题需要用到目标函数J关于自变量T的导数，也就是要对变换矩阵群T求导，然而，T上对加法并没有封闭性，导致无法直接求导，故而转向其唯一映射的李代数，李代数对加法具有封闭性，可以进行求导

#### SO(3)上的李代数求导

该模型用李代数表示姿态，根据李代数加法的定义，对李代数求导。

设一点p，经过旋转矩阵R得到Rp，现在要求旋转后的坐标对旋转矩阵的导数,直接用对应的李代数表示姿态
$$
\frac{\partial (\exp(\phi^{\wedge})p)}{\partial \phi}=
\lim_{\Delta\phi\rightarrow0}\frac{\exp((\phi+\Delta\phi)^{\wedge})p-\exp(\phi^{\wedge})p}{\Delta \phi}\\=
\lim_{\Delta\phi\rightarrow0}\frac{\exp((J_l(\phi)\Delta\phi)^{\wedge})\exp(\phi^{\wedge})p-\exp(\phi^{\wedge})p}{\Delta \phi}\\=
\lim_{\Delta\phi\rightarrow0}\frac{(I+(J_l(\phi)\Delta\phi)^{\wedge})\exp(\phi^{\wedge})p-\exp(\phi^{\wedge})p}{\Delta \phi}\\=
\lim_{\Delta\phi\rightarrow0}\frac{(J_l(\phi)\Delta\phi)^{\wedge}\exp(\phi^{\wedge})p}{\Delta \phi}\\=
\lim_{\Delta\phi\rightarrow0}\frac{-(\exp(\phi^{\wedge})p)^{\wedge}J_l(\phi)\Delta\phi}{\Delta \phi}\\=
-(Rp)^{\wedge}J_l
$$
其中，第二式为左乘近似公式，第三式为一阶泰勒展开，第五式将反对称矩阵与一矩阵相乘看做叉积过程，交换后符号取反，详细见上一讲的数学基础部分，这样得到了李代数求导的结果，但计算上还是比较复杂的。

#### SO(3)左乘扰动模型

对李群左乘或者右乘微小扰动，然后对扰动求导，分为左扰动和右扰动模型，这里以左乘扰动模型为例。

使李群左乘一个扰动，并利用近似公式,对扰动的李代数求导
$$
令扰动\triangle R = \exp(\varphi^{\wedge}),对该扰动求导如下\\
\frac{\partial Rp}{\partial \varphi}=
\lim_{\varphi\rightarrow0}\frac{\exp(\varphi^{\wedge})\exp(\phi^{\wedge})p-\exp(\phi^{\wedge})p}{\varphi}\\=
\lim_{\varphi\rightarrow0}\frac{(I+\varphi^{\wedge})exp(\phi^{\wedge})p-\exp(\phi^{\wedge})p}{\varphi}\\=
\lim_{\varphi\rightarrow0}\frac{\varphi^{\wedge}exp(\phi^{\wedge})p}{\varphi}\\=
-\lim_{\varphi\rightarrow0}\frac{\varphi(\exp(\phi^{\wedge})p)^{\wedge}}{\varphi}=-(Rp)^{\wedge}
$$
其中，第二式用到了一阶泰勒展开，第四式将反对称矩阵与一矩阵相乘看做叉积过程，交换后符号取反，详细见上一讲数学基础部分。

显然，对比上面第一个求导模型，省去了J的计算，这也使这种模型更为实用。

#### SE(3)左乘扰动模型

使变换矩阵左乘一个扰动，然后对扰动求导
$$
\triangle T = exp(\delta\xi^{\wedge}),\delta\xi=[\delta\rho,\delta\phi]^T\\
\frac{\partial (Tp)}{\partial \Delta\xi}=
\lim_{\delta\xi\rightarrow0}\frac{\exp(\delta\xi^{\wedge})\exp(\xi^{\wedge})p-\exp(\xi^{\wedge})p}{\delta\xi}\\=
\lim_{\delta\xi\rightarrow0}\frac{(I+\delta\xi^{\wedge})\exp(\xi^{\wedge})p-\exp(\xi^{\wedge})p}{\delta\xi}\\=
\lim_{\delta\xi\rightarrow0}\frac{\delta\xi^{\wedge}\exp(\xi^{\wedge})p}{\delta\xi}
$$
在之前，我们已经定义了
$$
\xi^{\wedge}=\begin{bmatrix}\phi^{\wedge}&\rho\\0^T&0\end{bmatrix}\\
exp(\xi^{\wedge})=\begin{bmatrix}R&t\\0^T&1\end{bmatrix}\\
$$
所以有
$$
\lim_{\delta\xi\rightarrow0}\frac{\delta\xi^{\wedge}\exp(\xi^{\wedge})p}{\delta\xi}=
\lim_{\delta\xi\rightarrow0}\frac{\begin{bmatrix}\delta\phi^{\wedge}&\delta\rho\\0^T&0\end{bmatrix}\begin{bmatrix}R&t\\0^T&1\end{bmatrix}p}{\delta\xi}=
\lim_{\delta\xi\rightarrow0}\frac{\begin{bmatrix}\delta\phi^{\wedge}&\delta\rho\\0^T&0\end{bmatrix}\begin{bmatrix}Rp+t\\1\end{bmatrix}}{\delta\xi}\\=
\lim_{\delta\xi\rightarrow0}\frac{\begin{bmatrix}\delta\phi^{\wedge}(Rp+t)+\delta\rho\\0^T\end{bmatrix}}{[\delta\rho,\delta\phi]^T}=\begin{bmatrix}I&(-Rp+t)^{\wedge}\\0^T&0^T\end{bmatrix}
$$
最后一步是来源于
$$
\frac{d\begin{bmatrix}a\\b\end{bmatrix}}{d\begin{bmatrix}x\\y\end{bmatrix}}=
\begin{bmatrix}\frac{da}{dx}&\frac{da}{dy}\\\frac{db}{dx}&\frac{db}{dy}\end{bmatrix}
$$
由于计算较为复杂，暂时略去这一步的推导，综上，结果如下。
$$
\frac{\partial (Tp)}{\partial \Delta\xi}=
\begin{bmatrix}I&(-Rp+t)^{\wedge}\\0^T&0^T\end{bmatrix}
$$


## 实践模块

该讲的实践模块主要是让大家学会使用Sopuhs进行李群与李代数的映射以及扰动更新模型的应用，将上面的理论付诸实际。

首先安装sophus，采用源码编译安装

```bash
#安装Sopuhs
#先将高翔的slambook2/3rdParty中对应版本的Sophusclone下来
cd Sophus
mkdir build
cmake ..
make
sudo make install
```

然后正常编译ch4中的代码，并尝试运行。

useSophus.cpp中已经注释的十分清楚了，包含了旋转矩阵群和变换矩阵群的初始化，两类李代数的初始化，左乘扰动模型更新。

书上还有另外一个例子：评价轨迹误差。该程序将ground truth与estimated两个文件中的信息读出并转换成变换矩阵群SE(3)，其误差根据书上提供的误差定义编程实现，注释也比较清楚，这里不多赘述。

